<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üéØ Professional Certificate Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Rich Color Scheme */
    :root {
      --gold: #D4AF37;
      --rich-black: #0A0A0A;
      --royal-navy: #0D1B2A;
      --champagne-white: #F7F2E7;
      --charcoal-grey: #2E2E2E;
      --dark-teal: #093A3E;
    }

    body {
      background-color: var(--champagne-white);
      color: var(--rich-black);
      font-family: 'Outfit', sans-serif;
    }

    .field {
      position: absolute;
      padding: 8px 12px;
      border: 2px solid var(--gold);
      background: rgba(247, 242, 231, 0.95);
      cursor: move;
      font-size: 16px;
      color: var(--rich-black);
      border-radius: 8px;
      user-select: none;
      box-shadow: 0 2px 8px rgba(10, 10, 10, 0.1);
      pointer-events: auto;
      z-index: 10;
      font-weight: normal;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      min-width: 120px;
      text-align: center;
    }

    .field.selected {
      border-color: var(--dark-teal);
      background: rgba(212, 175, 55, 0.15);
      color: var(--royal-navy);
      box-shadow: 0 4px 12px rgba(9, 58, 62, 0.25);
      transform: scale(1.03);
      z-index: 20;
    }

    .field .coords {
      font-size: 10px;
      color: var(--charcoal-grey);
      margin-top: 4px;
      font-weight: 400;
    }

    #directionPad {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: 10px;
      width: 150px;
      z-index: 1000;
      background: var(--champagne-white);
      padding: 15px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(10, 10, 10, 0.15);
      border: 1px solid rgba(212, 175, 55, 0.2);
    }

    .mobile-controls {
      display: none;
    }

    .gradient-text {
      background: linear-gradient(135deg, var(--gold), var(--dark-teal));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .step-card .card-header {
      background: linear-gradient(135deg, var(--royal-navy), var(--dark-teal));
      color: var(--champagne-white);
      border: none;
    }

    .step-card:nth-child(2) .card-header {
      background: linear-gradient(135deg, var(--dark-teal), var(--royal-navy));
    }

    .step-card:nth-child(3) .card-header {
      background: linear-gradient(135deg, var(--charcoal-grey), var(--royal-navy));
    }

    .step-card:nth-child(4) .card-header {
      background: linear-gradient(135deg, var(--gold), var(--charcoal-grey));
      color: var(--rich-black);
    }

    .template-container {
      min-height: 400px;
      border: 2px dashed var(--charcoal-grey);
      border-radius: 12px;
      overflow: hidden;
      background-color: var(--champagne-white);
      transition: all 0.3s ease;
    }

    .template-container.has-background {
      border: 1px solid var(--charcoal-grey);
      box-shadow: 0 4px 20px rgba(10, 10, 10, 0.08);
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(10, 10, 10, 0.08);
      transition: all 0.3s ease;
      background-color: var(--champagne-white);
    }

    .card:hover {
      box-shadow: 0 8px 30px rgba(10, 10, 10, 0.12);
      transform: translateY(-2px);
    }

    .btn-primary {
      background-color: var(--royal-navy);
      border-color: var(--royal-navy);
    }

    .btn-primary:hover {
      background-color: var(--dark-teal);
      border-color: var(--dark-teal);
    }

    .btn-success {
      background-color: var(--dark-teal);
      border-color: var(--dark-teal);
    }

    .btn-success:hover {
      background-color: #072a2d;
      border-color: #072a2d;
    }

    .btn-outline-secondary {
      border-color: var(--charcoal-grey);
      color: var(--charcoal-grey);
    }

    .btn-outline-secondary:hover {
      background-color: var(--charcoal-grey);
      border-color: var(--charcoal-grey);
      color: var(--champagne-white);
    }

    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid var(--charcoal-grey);
      background-color: var(--champagne-white);
      color: var(--rich-black);
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--gold);
      box-shadow: 0 0 0 0.2rem rgba(212, 175, 55, 0.15);
    }

    .debug-info {
      background-color: var(--champagne-white);
      border-left: 4px solid var(--gold);
    }

    .loading-modal .modal-content {
      background-color: var(--champagne-white);
      border: 1px solid var(--gold);
    }

    .loading-modal .spinner-border {
      color: var(--gold);
    }

    .loading-modal .text-primary {
      color: var(--royal-navy) !important;
    }

    @media (max-width: 768px) {
      #directionPad {
        display: none;
      }
      
      .mobile-controls {
        display: block;
        background-color: var(--champagne-white);
        border: 1px solid rgba(212, 175, 55, 0.2);
      }
      
      .template-container {
        min-height: 300px;
      }
    }

    @media (max-width: 576px) {
      .template-container {
        min-height: 250px;
      }
    }
  </style>
</head>
<body>

<!-- Loading Modal -->
<div class="modal fade loading-modal" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-body text-center py-5">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <h5 class="text-primary" id="loadingText">Processing...</h5>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid py-4">
  <div class="row justify-content-center mb-4">
    <div class="col-12 col-lg-10 col-xl-8 text-center">
      <h1 class="fw-bold display-4 mb-2 gradient-text">Certificate Generator</h1>
      <p class="fs-5" style="color: var(--charcoal-grey);">Create beautiful certificates with pixel-perfect precision</p>
    </div>
  </div>

  <div class="row g-4">
    <!-- Left Column - Steps 1-3 -->
    <div class="col-12 col-lg-4">
      <div class="row g-4">
        <!-- Step 1 -->
        <div class="col-12">
          <div class="card step-card h-100">
            <div class="card-header py-3">
              <div class="d-flex justify-content-between align-items-center">
                <span class="d-flex align-items-center">
                  <span class="bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 28px; height: 28px;">1</span>
                  Upload Data
                </span>
                <i class="bi bi-filetype-csv"></i>
              </div>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="csvFile" class="form-label fw-medium">Select CSV File</label>
                <input type="file" id="csvFile" accept=".csv" class="form-control rounded-2 py-2 px-3">
              </div>
              <div class="small" style="color: var(--charcoal-grey);">
                <i class="bi bi-info-circle me-1"></i>
                CSV must contain headers (e.g., Name, Course, Date, Score)
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="col-12">
          <div class="card step-card h-100">
            <div class="card-header py-3">
              <div class="d-flex justify-content-between align-items-center">
                <span class="d-flex align-items-center">
                  <span class="bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 28px; height: 28px;">2</span>
                  Upload Template
                </span>
                <i class="bi bi-image"></i>
              </div>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="templateFile" class="form-label fw-medium">Select Template Image</label>
                <input type="file" id="templateFile" accept="image/*" class="form-control rounded-2 py-2 px-3">
              </div>
              <div class="small" style="color: var(--charcoal-grey);">
                <i class="bi bi-info-circle me-1"></i>
                JPG, PNG, or other image formats supported
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="col-12">
          <div class="card step-card h-100">
            <div class="card-header py-3">
              <div class="d-flex justify-content-between align-items-center">
                <span class="d-flex align-items-center">
                  <span class="bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 28px; height: 28px;">3</span>
                  Add Text Fields
                </span>
                <i class="bi bi-text-paragraph"></i>
              </div>
            </div>
            <div class="card-body">
              <div id="columns" class="d-flex flex-wrap gap-2 mb-3"></div>
              <div id="noColumns" class="text-center py-4" style="color: var(--charcoal-grey);">
                <i class="bi bi-table display-4 opacity-50 mb-2"></i>
                <p class="mb-0">Upload a CSV file to see available columns</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Step 4 and Controls -->
    <div class="col-12 col-lg-8">
      <div class="row g-4">
        <!-- Step 4 -->
        <div class="col-12">
          <div class="card step-card h-100">
            <div class="card-header py-3">
              <div class="d-flex justify-content-between align-items-center">
                <span class="d-flex align-items-center">
                  <span class="bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 28px; height: 28px;">4</span>
                  Position & Style Fields
                </span>
                <i class="bi bi-palette"></i>
              </div>
            </div>
            <div class="card-body">
              <div class="template-container" id="templateContainer">
                <div id="template" class="w-100 h-100 position-relative" style="background-size: contain; background-repeat: no-repeat; background-position: center; min-height: 400px;">
                  <div class="d-flex flex-column align-items-center justify-content-center h-100" style="color: var(--charcoal-grey);">
                    <i class="bi bi-card-image display-1 opacity-50 mb-3"></i>
                    <p class="fs-5">Upload a template to get started</p>
                  </div>
                </div>
              </div>

              <!-- Mobile Controls -->
              <div class="mobile-controls rounded-3 p-3 mt-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0 fw-medium">Field Controls</h6>
                  <span class="badge" style="background-color: var(--royal-navy);" id="selectedFieldName">None</span>
                </div>
                <div class="row g-2">
                  <div class="col-4 d-grid">
                    <button class="btn up" style="background-color: var(--dark-teal); color: white;" title="Move Up"><i class="bi bi-arrow-up"></i></button>
                  </div>
                  <div class="col-4 d-grid">
                    <button class="btn del" style="background-color: #8B0000; color: white;" title="Delete Field"><i class="bi bi-trash"></i></button>
                  </div>
                  <div class="col-4 d-grid">
                    <button class="btn down" style="background-color: var(--dark-teal); color: white;" title="Move Down"><i class="bi bi-arrow-down"></i></button>
                  </div>
                  <div class="col-4 d-grid">
                    <button class="btn left" style="background-color: var(--royal-navy); color: white;" title="Move Left"><i class="bi bi-arrow-left"></i></button>
                  </div>
                  <div class="col-4"></div>
                  <div class="col-4 d-grid">
                    <button class="btn right" style="background-color: var(--royal-navy); color: white;" title="Move Right"><i class="bi bi-arrow-right"></i></button>
                  </div>
                </div>
              </div>

              <div id="fieldControls" class="rounded-3 p-4 mt-4" style="display:none; background-color: var(--champagne-white); border: 1px solid rgba(212, 175, 55, 0.2);">
                <h5 class="mb-3 fw-medium" style="color: var(--royal-navy);"><i class="bi bi-palette2 me-2"></i> Field Styling</h5>
                <div class="row g-4 align-items-center">
                  <div class="col-md-4">
                    <label class="form-label fw-medium">Text Color</label>
                    <input type="color" id="colorPicker" value="#0A0A0A" class="form-control form-control-color w-100 p-1 rounded-2">
                  </div>
                  <div class="col-md-5">
                    <label class="form-label fw-medium">Font Size</label>
                    <div class="d-flex align-items-center">
                      <input type="range" id="sizeSlider" min="8" max="72" value="16" class="form-range flex-grow-1">
                      <span id="sizeValue" class="ms-3 fw-bold">16px</span>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label fw-medium">Font Weight</label>
                    <div class="d-flex align-items-center mt-2">
                      <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="boldToggle">
                        <label class="form-check-label" for="boldToggle">Bold</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="col-12">
          <div class="d-flex gap-3 flex-wrap">
            <button id="previewBtn" class="btn btn-primary py-2 px-4 rounded-2 flex-fill" disabled>
              <i class="bi bi-eye me-2"></i> Preview Sample PDF
            </button>
            <button id="generateBtn" class="btn btn-success py-2 px-4 rounded-2 flex-fill" disabled>
              <i class="bi bi-file-earmark-zip me-2"></i> Generate All & Download ZIP
            </button>
          </div>
        </div>

        <!-- Debug Info -->
        <div class="col-12">
          <div class="rounded-3 p-3 debug-info" id="debugInfo">
            <div class="d-flex align-items-center">
              <i class="bi bi-info-circle me-2" style="color: var(--royal-navy);"></i>
              <span>No field selected. Click on a field to select and style it.</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Direction Pad (Desktop) -->
<div id="directionPad">
  <div></div>
  <button class="btn up rounded-2" style="background-color: var(--dark-teal); color: white;" title="Move Up (‚Üë)"><i class="bi bi-arrow-up"></i></button>
  <div></div>
  <button class="btn left rounded-2" style="background-color: var(--royal-navy); color: white;" title="Move Left (‚Üê)"><i class="bi bi-arrow-left"></i></button>
  <button class="btn del rounded-2" style="background-color: #8B0000; color: white;" title="Delete Field (Del)"><i class="bi bi-trash"></i></button>
  <button class="btn right rounded-2" style="background-color: var(--royal-navy); color: white;" title="Move Right (‚Üí)"><i class="bi bi-arrow-right"></i></button>
  <div></div>
  <button class="btn down rounded-2" style="background-color: var(--dark-teal); color: white;" title="Move Down (‚Üì)"><i class="bi bi-arrow-down"></i></button>
  <div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// All the JavaScript code from the original remains the same
// Only the CSS and HTML structure have been enhanced
let participants = [];
let fields = [];
let templateUrl = "";
let selectedField = null;

const colorInput = document.getElementById('colorPicker');
const sizeSlider = document.getElementById('sizeSlider');
const sizeValue = document.getElementById('sizeValue');
const boldToggle = document.getElementById('boldToggle');
const fieldControls = document.getElementById('fieldControls');
const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
const loadingText = document.getElementById('loadingText');
const noColumnsEl = document.getElementById('noColumns');
const templateContainer = document.getElementById('templateContainer');
const selectedFieldName = document.getElementById('selectedFieldName');

function showLoading(text = "Processing...") {
  loadingText.textContent = text;
  loadingModal.show();
}

function hideLoading() {
  loadingModal.hide();
}

document.getElementById("csvFile").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append("csv", file);
  try {
    const res = await fetch("/upload-csv", { method: "POST", body: formData });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    participants = data.participants;
    updateColumnsUI(data.columns);
    checkReady();
  } catch (err) {
    alert("CSV upload failed: " + err.message);
  } finally {
    hideLoading();
  }
});

document.getElementById("templateFile").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  showLoading("Uploading template...");
  const formData = new FormData();
  formData.append("template", file);
  try {
    const res = await fetch("/upload-template", { method: "POST", body: formData });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    templateUrl = data.templateUrl;
    document.getElementById("template").style.backgroundImage = `url(${templateUrl})`;
    templateContainer.classList.add("has-background");
    document.getElementById("template").innerHTML = "";
    checkReady();
  } catch (err) {
    alert("Template upload failed: " + err.message);
  } finally {
    hideLoading();
  }
});

function updateColumnsUI(columns) {
  const div = document.getElementById("columns");
  noColumnsEl.style.display = columns.length ? "none" : "block";
  div.innerHTML = "";
  if (columns.length === 0) return;

  columns.forEach(col => {
    const btn = document.createElement("button");
    btn.innerHTML = `<i class="bi bi-plus-circle me-1"></i> ${col}`;
    btn.className = "btn btn-sm btn-outline-secondary rounded-1";
    btn.title = `Add field: ${col}`;
    btn.onclick = () => addField(col);
    div.appendChild(btn);
  });
}

function addField(name) {
  const existing = document.querySelector(`.field[data-field-name="${name}"]`);
  if (existing) {
    alert(`Field "${name}" already exists on the template!`);
    existing.scrollIntoView({ behavior: 'smooth' });
    existing.click();
    return;
  }

  const field = document.createElement("div");
  field.className = "field";
  field.innerHTML = `${name}<div class="coords">(50, 50)</div>`;
  field.style.left = "50px";
  field.style.top = "50px";
  field.dataset.fieldName = name;
  field.style.fontSize = "16px";
  field.style.color = "#0A0A0A";
  field.style.fontWeight = "normal";

  field.addEventListener("click", (e) => {
    e.stopPropagation();
    if (selectedField) selectedField.classList.remove("selected");
    selectedField = field;
    field.classList.add("selected");
    updateFieldControls();
    updateDebug();
    selectedFieldName.textContent = name;
  });

  field.draggable = true;
  field.addEventListener("dragstart", (e) => {
    e.dataTransfer.setData("text/plain", name);
    field.style.opacity = "0.7";
  });
  field.addEventListener("dragend", () => {
    field.style.opacity = "1";
  });

  let touchStartX, touchStartY, elementStartX, elementStartY;
  field.addEventListener("touchstart", (e) => {
    const touch = e.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    elementStartX = parseInt(field.style.left) || 0;
    elementStartY = parseInt(field.style.top) || 0;
    field.style.transition = "none";
    if (!selectedField || selectedField !== field) {
      if (selectedField) selectedField.classList.remove("selected");
      selectedField = field;
      field.classList.add("selected");
      updateFieldControls();
      updateDebug();
      selectedFieldName.textContent = name;
    }
    e.preventDefault();
  });

  field.addEventListener("touchmove", (e) => {
    if (!selectedField || selectedField !== field) return;
    const touch = e.touches[0];
    let x = elementStartX + (touch.clientX - touchStartX);
    let y = elementStartY + (touch.clientY - touchStartY);
    const templateRect = document.getElementById("template").getBoundingClientRect();
    x = Math.max(0, Math.min(templateRect.width - 120, x));
    y = Math.max(0, Math.min(templateRect.height - 50, y));
    field.style.left = x + 'px';
    field.style.top = y + 'px';
    field.querySelector('.coords').textContent = `(${Math.round(x)}, ${Math.round(y)})`;
    const f = fields.find(f => f.field === name);
    if (f) { f.x = x; f.y = y; }
    e.preventDefault();
  });

  field.addEventListener("touchend", () => {
    field.style.transition = "";
  });

  document.getElementById("template").appendChild(field);
  fields.push({
    field: name,
    x: 50,
    y: 50,
    size: 16,
    color: "#0A0A0A",
    bold: false,
    element: field
  });
  checkReady();
}

document.getElementById("template").addEventListener("click", (e) => {
  if (e.target === document.getElementById("template")) {
    if (selectedField) {
      selectedField.classList.remove("selected");
      selectedField = null;
      hideFieldControls();
      updateDebug();
      selectedFieldName.textContent = "None";
    }
  }
});

document.getElementById("template").addEventListener("dragover", (e) => e.preventDefault());
document.getElementById("template").addEventListener("drop", (e) => {
  e.preventDefault();
  const fieldName = e.dataTransfer.getData("text/plain");
  const rect = document.getElementById("template").getBoundingClientRect();
  const x = Math.max(0, Math.min(rect.width - 120, e.clientX - rect.left));
  const y = Math.max(0, Math.min(rect.height - 50, e.clientY - rect.top));

  const fieldEl = document.querySelector(`.field[data-field-name="${fieldName}"]`);
  if (fieldEl) {
    fieldEl.style.left = x + 'px';
    fieldEl.style.top = y + 'px';
    fieldEl.querySelector('.coords').textContent = `(${Math.round(x)}, ${Math.round(y)})`;
    const f = fields.find(f => f.field === fieldName);
    if (f) { f.x = x; f.y = y; }
    if (fieldEl === selectedField) updateDebug();
  }
});

colorInput.addEventListener('input', () => {
  if (!selectedField) return;
  const color = colorInput.value;
  selectedField.style.color = color;
  const f = fields.find(f => f.element === selectedField);
  if (f) f.color = color;
});

sizeSlider.addEventListener('input', () => {
  if (!selectedField) return;
  const size = sizeSlider.value;
  sizeValue.textContent = size + 'px';
  selectedField.style.fontSize = size + 'px';
  const f = fields.find(f => f.element === selectedField);
  if (f) f.size = parseInt(size);
});

boldToggle.addEventListener('change', () => {
  if (!selectedField) return;
  const isBold = boldToggle.checked;
  selectedField.style.fontWeight = isBold ? 'bold' : 'normal';
  const f = fields.find(f => f.element === selectedField);
  if (f) f.bold = isBold;
});

function updateFieldControls() {
  if (!selectedField) {
    hideFieldControls();
    return;
  }
  fieldControls.style.display = 'block';
  const f = fields.find(f => f.element === selectedField);
  if (f) {
    colorInput.value = f.color;
    sizeSlider.value = f.size;
    sizeValue.textContent = f.size + 'px';
    boldToggle.checked = f.bold;
  }
}

function hideFieldControls() {
  fieldControls.style.display = 'none';
}

document.addEventListener("keydown", (e) => {
  if (!selectedField) return;
  const step = e.shiftKey ? 10 : 1;
  let x = parseInt(selectedField.style.left) || 0;
  let y = parseInt(selectedField.style.top) || 0;
  const templateRect = document.getElementById("template").getBoundingClientRect();

  switch(e.key) {
    case "ArrowLeft":  x = Math.max(0, x - step); break;
    case "ArrowRight": x = Math.min(templateRect.width - 120, x + step); break;
    case "ArrowUp":    y = Math.max(0, y - step); break;
    case "ArrowDown":  y = Math.min(templateRect.height - 50, y + step); break;
    case "Delete":
    case "Backspace":
      deleteSelectedField();
      return;
    default: return;
  }

  selectedField.style.left = x + 'px';
  selectedField.style.top = y + 'px';
  selectedField.querySelector('.coords').textContent = `(${x}, ${y})`;
  const f = fields.find(f => f.element === selectedField);
  if (f) { f.x = x; f.y = y; }
  updateDebug();
  e.preventDefault();
});

function createDirectionPad() {
  const pad = document.getElementById('directionPad');
  pad.querySelector('.up').onclick = () => simulateKey('ArrowUp');
  pad.querySelector('.down').onclick = () => simulateKey('ArrowDown');
  pad.querySelector('.left').onclick = () => simulateKey('ArrowLeft');
  pad.querySelector('.right').onclick = () => simulateKey('ArrowRight');
  pad.querySelector('.del').onclick = deleteSelectedField;
  
  // Mobile controls
  document.querySelector('.mobile-controls .up').onclick = () => simulateKey('ArrowUp');
  document.querySelector('.mobile-controls .down').onclick = () => simulateKey('ArrowDown');
  document.querySelector('.mobile-controls .left').onclick = () => simulateKey('ArrowLeft');
  document.querySelector('.mobile-controls .right').onclick = () => simulateKey('ArrowRight');
  document.querySelector('.mobile-controls .del').onclick = deleteSelectedField;
}

function simulateKey(key) {
  if (!selectedField) return;
  const event = new KeyboardEvent("keydown", { key });
  document.dispatchEvent(event);
}

function deleteSelectedField() {
  if (!selectedField) return;
  const fieldName = selectedField.dataset.fieldName;
  selectedField.remove();
  fields = fields.filter(f => f.field !== fieldName);
  selectedField = null;
  hideFieldControls();
  checkReady();
  document.getElementById("debugInfo").innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-check-circle me-2" style="color: var(--dark-teal);"></i>
      <span>Field "${fieldName}" deleted</span>
    </div>
  `;
  selectedFieldName.textContent = "None";
  setTimeout(() => updateDebug(), 1000);
}

function updateDebug() {
  if (!selectedField) {
    document.getElementById("debugInfo").innerHTML = `
      <div class="d-flex align-items-center">
        <i class="bi bi-info-circle me-2" style="color: var(--royal-navy);"></i>
        <span>No field selected. Click on a field to select and style it.</span>
      </div>
    `;
    return;
  }
  const f = fields.find(f => f.element === selectedField);
  if (f) {
    document.getElementById("debugInfo").innerHTML = 
      `<div class="d-flex align-items-center">
        <i class="bi bi-pencil me-2" style="color: var(--gold);"></i>
        <span>
          Selected: <strong>${f.field}</strong> | Position: (${f.x}, ${f.y}) | Size: ${f.size}px | 
          Color: <span style="color:${f.color}; font-weight:bold;">‚óè</span> | Bold: ${f.bold ? 'Yes' : 'No'}
        </span>
      </div>`;
  }
}

function checkReady() {
  const isReady = participants.length > 0 && templateUrl && fields.length > 0;
  document.getElementById("previewBtn").disabled = !isReady;
  document.getElementById("generateBtn").disabled = !isReady;
}

document.getElementById("previewBtn").addEventListener("click", async () => {
  showLoading("Generating preview PDF...");
  try {
    if (!participants.length) return;
    const sample = participants[0];
    const payload = {
      participant: sample,
      templateUrl,
      fields: fields.map(f => ({ 
        field: f.field, 
        x: f.x, 
        y: f.y,
        size: f.size,
        color: f.color,
        bold: f.bold
      }))
    };
    const res = await fetch("/preview-pdf", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("Preview failed");
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    window.open(url, '_blank');
  } catch (err) {
    alert("Preview error: " + err.message);
  } finally {
    hideLoading();
  }
});

document.getElementById("generateBtn").addEventListener("click", async () => {
  showLoading("Generating ZIP with all certificates...");
  try {
    const payload = {
      participants,
      templateUrl,
      fields: fields.map(f => ({ 
        field: f.field, 
        x: f.x, 
        y: f.y,
        size: f.size,
        color: f.color,
        bold: f.bold
      }))
    };
    const res = await fetch("/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("Generation failed");
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "certificates_bulk.zip";
    a.click();
    window.URL.revokeObjectURL(url);
    document.getElementById("debugInfo").innerHTML = `
      <div class="d-flex align-items-center">
        <i class="bi bi-check-circle me-2" style="color: var(--dark-teal);"></i>
        <span>ZIP downloaded successfully!</span>
      </div>
    `;
  } catch (err) {
    alert("Generation error: " + err.message);
  } finally {
    hideLoading();
  }
});

window.addEventListener("load", () => {
  createDirectionPad();
  updateDebug();
});
</script>
</body>
</html>
