<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Certificate Generator</title>
  <style>
    body {
      font-family: Arial;
      margin: 20px;
    }
    #template-container {
      width: 600px;
      height: 400px;
      border: 2px dashed #bbb;
      position: relative;
      margin-top: 20px;
      background-size: cover;
      background-position: center;
    }
    .field {
      position: absolute;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid #666;
      cursor: move;
      border-radius: 4px;
    }
    #fields-list div {
      padding: 6px;
      margin-bottom: 5px;
      background: #eee;
      width: 200px;
      cursor: grab;
    }
  </style>
</head>
<body>

  <h2>CSV Upload</h2>
  <input type="file" id="csvInput">

  <h3>Fields</h3>
  <div id="fields-list"></div>

  <h3>Upload Template</h3>
  <input type="file" id="templateInput">

  <h2>Template Preview</h2>
  <div id="template-container"></div>

  <br><br>
  <button id="generateBtn">Generate Certificates ZIP</button>

  <script>
    let csvData = [];
    let fields = [];
    let templateUrl = "";

    // ---------------------------
    // CSV Upload
    // ---------------------------
    document.getElementById("csvInput").addEventListener("change", function () {
      const file = this.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const text = e.target.result;
        const rows = text.split("\n").map(r => r.trim()).filter(r => r.length);
        const headers = rows[0].split(",");

        csvData = rows.slice(1).map(r => {
          const values = r.split(",");
          let obj = {};
          headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
          return obj;
        });

        const list = document.getElementById("fields-list");
        list.innerHTML = "";

        headers.forEach(h => addField(h));
      };

      reader.readAsText(file);
    });


    // ---------------------------
    // Template Upload
    // ---------------------------
    document.getElementById("templateInput").addEventListener("change", async function () {
      const file = this.files[0];
      const formData = new FormData();
      formData.append("template", file);

      const res = await fetch("/upload-template", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      templateUrl = data.url;

      document.getElementById("template-container").style.backgroundImage =
        `url(${templateUrl})`;
    });


    // ---------------------------
    // Add draggable field (FIXED)
    // ---------------------------
    function addField(name) {
      const container = document.getElementById("template-container");

      const field = document.createElement("div");
      field.className = "field";
      field.innerText = name;

      const uid = Date.now() + Math.random();
      field.setAttribute("draggable", "true");
      field.dataset.uid = uid;
      field.dataset.fieldName = name;

      field.style.left = "50px";
      field.style.top = "50px";

      container.appendChild(field);

      fields.push({ uid, field: name, x: 50, y: 50, element: field });

      // Drag start
      field.addEventListener("dragstart", function (e) {
        e.dataTransfer.setData("text/plain", uid);
      });
    }


    // ---------------------------
    // Drop â†’ Move element (FIXED)
    // ---------------------------
    const templateContainer = document.getElementById("template-container");

    templateContainer.addEventListener("dragover", function (e) {
      e.preventDefault();
    });

    templateContainer.addEventListener("drop", function (e) {
      e.preventDefault();

      const uid = e.dataTransfer.getData("text/plain");
      const fieldEl = document.querySelector(`.field[data-uid="${uid}"]`);
      if (!fieldEl) return;

      const rect = templateContainer.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      fieldEl.style.left = `${x}px`;
      fieldEl.style.top = `${y}px`;

      const f = fields.find(f => f.uid == uid);
      if (f) {
        f.x = x;
        f.y = y;
      }
    });


    // ---------------------------
    // Generate ZIP
    // ---------------------------
    document.getElementById("generateBtn").addEventListener("click", async function () {
      if (!templateUrl) {
        alert("Please upload a template first.");
        return;
      }

      const res = await fetch("/generate", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          participants: csvData,
          templateUrl,
          fields: fields.map(f => ({
            uid: f.uid,
            field: f.field,
            x: f.x,
            y: f.y
          }))
        })
      });

      if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "certificates.zip";
        a.click();
      }
    });
    

  </script>

</body>
</html>
