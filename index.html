<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üéØ Precise Certificate Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
    }
    #template {
      border: 1px solid #dee2e6;
      width: 100%;
      max-width: 600px;
      height: 400px;
      position: relative;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      margin: 15px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
      background-color: #f8f9fa;
    }
    .field {
      position: absolute;
      padding: 4px 8px;
      border: 2px solid #0d6efd;
      background: rgba(255,255,255,0.92);
      cursor: move;
      font-size: 16px;
      color: #000;
      border-radius: 6px;
      user-select: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      pointer-events: auto;
      z-index: 10;
      font-weight: normal;
      transition: all 0.15s ease;
    }
    .field.selected {
      border-color: #fd7e14;
      background: rgba(255,248,235,0.95);
      color: #d32f2f;
      box-shadow: 0 3px 8px rgba(253,126,20,0.3);
      transform: scale(1.03);
    }
    .field .coords {
      font-size: 10px;
      color: #6c757d;
      margin-top: 2px;
    }
    #directionPad {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: 8px;
      width: 130px;
      z-index: 1000;
    }
    #directionPad button {
      padding: 10px !important;
      font-size: 20px !important;
      border: none !important;
      border-radius: 8px !important;
      cursor: pointer;
      transition: all 0.2s;
    }
    #directionPad button:active {
      transform: scale(0.95);
    }
    .debug {
      min-height: 1.4em;
      font-size: 0.95rem;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-top: 5px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .step-card {
      transition: box-shadow 0.3s;
    }
    .step-card:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.12);
    }
    .btn-add-field {
      transition: all 0.2s;
    }
    .btn-add-field:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body class="bg-light">

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="text-center">
    <div class="spinner mb-3"></div>
    <div class="text-white h5 mb-0" id="loadingText">Processing...</div>
  </div>
</div>

<div class="container py-4">
  <h1 class="mb-4 text-center display-5 fw-bold">üéØ Precise Certificate Generator</h1>

  <!-- Step 1 -->
  <div class="card mb-4 step-card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <span>Step 1: Upload CSV</span>
      <i class="bi bi-filetype-csv"></i>
    </div>
    <div class="card-body">
      <input type="file" id="csvFile" accept=".csv" class="form-control">
      <div class="mt-2 text-muted small">CSV must contain headers (e.g., Name, Course, Date)</div>
    </div>
  </div>

  <!-- Step 2 -->
  <div class="card mb-4 step-card">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
      <span>Step 2: Upload Template (JPG/PNG)</span>
      <i class="bi bi-image"></i>
    </div>
    <div class="card-body">
      <input type="file" id="templateFile" accept="image/*" class="form-control">
    </div>
  </div>

  <!-- Step 3 -->
  <div class="card mb-4 step-card">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <span>Step 3: Add Fields</span>
      <i class="bi bi-text-paragraph"></i>
    </div>
    <div class="card-body">
      <div id="columns" class="d-flex flex-wrap gap-2 mb-2"></div>
      <div id="noColumns" class="text-muted small">Upload CSV to see columns</div>
    </div>
  </div>

  <!-- Step 4 -->
  <div class="card mb-4 step-card">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
      <span>Step 4: Position & Style Fields</span>
      <i class="bi bi-palette"></i>
    </div>
    <div class="card-body">
      <div id="template"></div>

      <div id="fieldControls" class="mt-3 p-3 bg-white border rounded shadow-sm" style="display:none;">
        <h6 class="mb-3">üé® Field Styling</h6>
        <div class="row g-3 align-items-center">
          <div class="col-md-4">
            <label class="form-label mb-1">Text Color</label>
            <input type="color" id="colorPicker" value="#000000" class="form-control form-control-color w-100 p-1">
          </div>
          <div class="col-md-5">
            <label class="form-label mb-1">Font Size (px)</label>
            <div class="d-flex align-items-center">
              <input type="range" id="sizeSlider" min="8" max="60" value="16" class="form-range flex-grow-1">
              <span id="sizeValue" class="ms-2 fw-bold">16</span>
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label mb-1">Bold</label>
            <div class="form-check form-switch mt-1">
              <input class="form-check-input" type="checkbox" id="boldToggle">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2 mb-3">
    <button id="previewBtn" class="btn btn-primary" disabled>
      <i class="bi bi-eye me-1"></i> Preview Sample PDF
    </button>
    <button id="generateBtn" class="btn btn-success" disabled>
      <i class="bi bi-file-earmark-zip me-1"></i> Generate All & Download ZIP
    </button>
  </div>

  <div class="debug text-muted small" id="debugInfo">No field selected</div>
</div>

<!-- Direction Pad -->
<div id="directionPad">
  <button class="btn btn-success up" title="Move Up (‚Üë)"><i class="bi bi-arrow-up"></i></button>
  <button class="btn btn-primary left" title="Move Left (‚Üê)"><i class="bi bi-arrow-left"></i></button>
  <button class="btn btn-primary right" title="Move Right (‚Üí)"><i class="bi bi-arrow-right"></i></button>
  <button class="btn btn-success down" title="Move Down (‚Üì)"><i class="bi bi-arrow-down"></i></button>
  <button class="btn btn-danger del" style="grid-column:2; margin-top:8px;" title="Delete Field (Del)">
    <i class="bi bi-trash"></i>
  </button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
let participants = [];
let fields = [];
let templateUrl = "";
let selectedField = null;

const colorInput = document.getElementById('colorPicker');
const sizeSlider = document.getElementById('sizeSlider');
const sizeValue = document.getElementById('sizeValue');
const boldToggle = document.getElementById('boldToggle');
const fieldControls = document.getElementById('fieldControls');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText = document.getElementById('loadingText');
const noColumnsEl = document.getElementById('noColumns');

function showLoading(text = "Processing...") {
  loadingText.textContent = text;
  loadingOverlay.classList.add('show');
}

function hideLoading() {
  loadingOverlay.classList.remove('show');
}

document.getElementById("csvFile").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  showLoading("Parsing CSV...");
  const formData = new FormData();
  formData.append("csv", file);
  try {
    const res = await fetch("/upload-csv", { method: "POST", body: formData });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    participants = data.participants;
    updateColumnsUI(data.columns);
    checkReady();
  } catch (err) {
    alert("CSV upload failed: " + err.message);
  } finally {
    hideLoading();
  }
});

document.getElementById("templateFile").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  showLoading("Uploading template...");
  const formData = new FormData();
  formData.append("template", file);
  try {
    const res = await fetch("/upload-template", { method: "POST", body: formData });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    templateUrl = data.templateUrl;
    document.getElementById("template").style.backgroundImage = `url(${templateUrl})`;
    checkReady();
  } catch (err) {
    alert("Template upload failed: " + err.message);
  } finally {
    hideLoading();
  }
});

function updateColumnsUI(columns) {
  const div = document.getElementById("columns");
  noColumnsEl.style.display = columns.length ? "none" : "block";
  div.innerHTML = "";
  if (columns.length === 0) return;

  columns.forEach(col => {
    const btn = document.createElement("button");
    btn.innerHTML = `<i class="bi bi-plus-circle me-1"></i> ${col}`;
    btn.className = "btn btn-sm btn-outline-secondary btn-add-field";
    btn.title = `Add field: ${col}`;
    btn.onclick = () => addField(col);
    div.appendChild(btn);
  });
}

function addField(name) {
  const existing = document.querySelector(`.field[data-field-name="${name}"]`);
  if (existing) {
    alert(`Field "${name}" already exists on the template!`);
    existing.scrollIntoView({ behavior: 'smooth' });
    existing.click();
    return;
  }

  const field = document.createElement("div");
  field.className = "field";
  field.innerHTML = `${name}<div class="coords">(50, 50)</div>`;
  field.style.left = "50px";
  field.style.top = "50px";
  field.dataset.fieldName = name;
  field.style.fontSize = "16px";
  field.style.color = "#000000";
  field.style.fontWeight = "normal";

  field.addEventListener("click", (e) => {
    e.stopPropagation();
    if (selectedField) selectedField.classList.remove("selected");
    selectedField = field;
    field.classList.add("selected");
    updateFieldControls();
    updateDebug();
  });

  field.draggable = true;
  field.addEventListener("dragstart", (e) => {
    e.dataTransfer.setData("text/plain", name);
    field.style.opacity = "0.7";
  });
  field.addEventListener("dragend", () => {
    field.style.opacity = "1";
  });

  let touchStartX, touchStartY, elementStartX, elementStartY;
  field.addEventListener("touchstart", (e) => {
    const touch = e.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    elementStartX = parseInt(field.style.left) || 0;
    elementStartY = parseInt(field.style.top) || 0;
    field.style.transition = "none";
    if (!selectedField || selectedField !== field) {
      if (selectedField) selectedField.classList.remove("selected");
      selectedField = field;
      field.classList.add("selected");
      updateFieldControls();
      updateDebug();
    }
    e.preventDefault();
  });

  field.addEventListener("touchmove", (e) => {
    if (!selectedField || selectedField !== field) return;
    const touch = e.touches[0];
    let x = elementStartX + (touch.clientX - touchStartX);
    let y = elementStartY + (touch.clientY - touchStartY);
    x = Math.max(0, Math.min(590, x));
    y = Math.max(0, Math.min(390, y));
    field.style.left = x + 'px';
    field.style.top = y + 'px';
    field.querySelector('.coords').textContent = `(${Math.round(x)}, ${Math.round(y)})`;
    const f = fields.find(f => f.field === name);
    if (f) { f.x = x; f.y = y; }
    e.preventDefault();
  });

  field.addEventListener("touchend", () => {
    field.style.transition = "";
  });

  document.getElementById("template").appendChild(field);
  fields.push({
    field: name,
    x: 50,
    y: 50,
    size: 16,
    color: "#000000",
    bold: false,
    element: field
  });
  checkReady();
}

document.getElementById("template").addEventListener("click", (e) => {
  if (e.target === document.getElementById("template")) {
    if (selectedField) {
      selectedField.classList.remove("selected");
      selectedField = null;
      hideFieldControls();
      updateDebug();
    }
  }
});

document.getElementById("template").addEventListener("dragover", (e) => e.preventDefault());
document.getElementById("template").addEventListener("drop", (e) => {
  e.preventDefault();
  const fieldName = e.dataTransfer.getData("text/plain");
  const rect = document.getElementById("template").getBoundingClientRect();
  const x = Math.max(0, Math.min(590, e.clientX - rect.left));
  const y = Math.max(0, Math.min(390, e.clientY - rect.top));

  const fieldEl = document.querySelector(`.field[data-field-name="${fieldName}"]`);
  if (fieldEl) {
    fieldEl.style.left = x + 'px';
    fieldEl.style.top = y + 'px';
    fieldEl.querySelector('.coords').textContent = `(${Math.round(x)}, ${Math.round(y)})`;
    const f = fields.find(f => f.field === fieldName);
    if (f) { f.x = x; f.y = y; }
    if (fieldEl === selectedField) updateDebug();
  }
});

colorInput.addEventListener('input', () => {
  if (!selectedField) return;
  const color = colorInput.value;
  selectedField.style.color = color;
  const f = fields.find(f => f.element === selectedField);
  if (f) f.color = color;
});

sizeSlider.addEventListener('input', () => {
  if (!selectedField) return;
  const size = sizeSlider.value;
  sizeValue.textContent = size;
  selectedField.style.fontSize = size + 'px';
  const f = fields.find(f => f.element === selectedField);
  if (f) f.size = parseInt(size);
});

boldToggle.addEventListener('change', () => {
  if (!selectedField) return;
  const isBold = boldToggle.checked;
  selectedField.style.fontWeight = isBold ? 'bold' : 'normal';
  const f = fields.find(f => f.element === selectedField);
  if (f) f.bold = isBold;
});

function updateFieldControls() {
  if (!selectedField) {
    hideFieldControls();
    return;
  }
  fieldControls.style.display = 'block';
  const f = fields.find(f => f.element === selectedField);
  if (f) {
    colorInput.value = f.color;
    sizeSlider.value = f.size;
    sizeValue.textContent = f.size;
    boldToggle.checked = f.bold;
  }
}

function hideFieldControls() {
  fieldControls.style.display = 'none';
}

document.addEventListener("keydown", (e) => {
  if (!selectedField) return;
  const step = e.shiftKey ? 10 : 1;
  let x = parseInt(selectedField.style.left) || 0;
  let y = parseInt(selectedField.style.top) || 0;

  switch(e.key) {
    case "ArrowLeft":  x = Math.max(0, x - step); break;
    case "ArrowRight": x = Math.min(590, x + step); break;
    case "ArrowUp":    y = Math.max(0, y - step); break;
    case "ArrowDown":  y = Math.min(390, y + step); break;
    case "Delete":
    case "Backspace":
      deleteSelectedField();
      return;
    default: return;
  }

  selectedField.style.left = x + 'px';
  selectedField.style.top = y + 'px';
  selectedField.querySelector('.coords').textContent = `(${x}, ${y})`;
  const f = fields.find(f => f.element === selectedField);
  if (f) { f.x = x; f.y = y; }
  updateDebug();
  e.preventDefault();
});

function createDirectionPad() {
  const pad = document.getElementById('directionPad');
  pad.querySelector('.up').onclick = () => simulateKey('ArrowUp');
  pad.querySelector('.down').onclick = () => simulateKey('ArrowDown');
  pad.querySelector('.left').onclick = () => simulateKey('ArrowLeft');
  pad.querySelector('.right').onclick = () => simulateKey('ArrowRight');
  pad.querySelector('.del').onclick = deleteSelectedField;
}

function simulateKey(key) {
  if (!selectedField) return;
  const event = new KeyboardEvent("keydown", { key });
  document.dispatchEvent(event);
}

function deleteSelectedField() {
  if (!selectedField) return;
  const fieldName = selectedField.dataset.fieldName;
  selectedField.remove();
  fields = fields.filter(f => f.field !== fieldName);
  selectedField = null;
  hideFieldControls();
  checkReady();
  document.getElementById("debugInfo").textContent = `‚úÖ Field "${fieldName}" deleted`;
  setTimeout(() => updateDebug(), 1000);
}

function updateDebug() {
  if (!selectedField) {
    document.getElementById("debugInfo").textContent = "üí° Click a field to select and style it";
    return;
  }
  const f = fields.find(f => f.element === selectedField);
  if (f) {
    document.getElementById("debugInfo").innerHTML = 
      `‚úèÔ∏è Selected: <strong>${f.field}</strong> | Pos: (${f.x}, ${f.y}) | Size: ${f.size}px | 
       Color: <span style="color:${f.color}; font-weight:bold;">‚óè</span> | Bold: ${f.bold ? 'Yes' : 'No'}`;
  }
}

function checkReady() {
  const isReady = participants.length > 0 && templateUrl && fields.length > 0;
  document.getElementById("previewBtn").disabled = !isReady;
  document.getElementById("generateBtn").disabled = !isReady;
}

document.getElementById("previewBtn").addEventListener("click", async () => {
  showLoading("Generating preview PDF...");
  try {
    if (!participants.length) return;
    const sample = participants[0];
    const payload = {
      participant: sample,
      templateUrl,
      fields: fields.map(f => ({ 
        field: f.field, 
        x: f.x, 
        y: f.y,
        size: f.size,
        color: f.color,
        bold: f.bold
      }))
    };
    const res = await fetch("/preview-pdf", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("Preview failed");
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    window.open(url, '_blank');
  } catch (err) {
    alert("Preview error: " + err.message);
  } finally {
    hideLoading();
  }
});

document.getElementById("generateBtn").addEventListener("click", async () => {
  showLoading("Generating ZIP with all certificates...");
  try {
    const payload = {
      participants,
      templateUrl,
      fields: fields.map(f => ({ 
        field: f.field, 
        x: f.x, 
        y: f.y,
        size: f.size,
        color: f.color,
        bold: f.bold
      }))
    };
    const res = await fetch("/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("Generation failed");
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "certificates_bulk.zip";
    a.click();
    window.URL.revokeObjectURL(url);
    document.getElementById("debugInfo").textContent = "‚úÖ ZIP downloaded successfully!";
  } catch (err) {
    alert("Generation error: " + err.message);
  } finally {
    hideLoading();
  }
});

window.addEventListener("load", () => {
  createDirectionPad();
  updateDebug();
});
</script>
</body>
</html>
